{% extends 'dashboard/base.html' %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Analytics</h1>
    <p class="page-subtitle">Financial insights and performance metrics for your projects</p>
</div>

<div class="analytics-grid">
    <div class="analytics-card">
        <div class="analytics-header">
            <h3 class="analytics-title">Contract Status Distribution</h3>
            <span class="analytics-period">Current</span>
        </div>
        <div class="chart-container">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column;">
                {% with total_contracts=contracts_by_status.active|add:contracts_by_status.completed|add:contracts_by_status.pending|add:contracts_by_status.draft %}
                {% if total_contracts > 0 %}
                <div style="width: 140px; height: 140px; border-radius: 50%; position: relative; background: conic-gradient(
                    #3498db 0deg {{ contracts_by_status.active|mul:360|div:total_contracts }}deg,
                    #27ae60 {{ contracts_by_status.active|mul:360|div:total_contracts }}deg {{ contracts_by_status.active|add:contracts_by_status.completed|mul:360|div:total_contracts }}deg,
                    #f39c12 {{ contracts_by_status.active|add:contracts_by_status.completed|mul:360|div:total_contracts }}deg {{ contracts_by_status.active|add:contracts_by_status.completed|add:contracts_by_status.pending|mul:360|div:total_contracts }}deg,
                    #95a5a6 {{ contracts_by_status.active|add:contracts_by_status.completed|add:contracts_by_status.pending|mul:360|div:total_contracts }}deg 360deg
                ); margin-bottom: 1rem;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--gray-800);">{{ total_contracts }}</div>
                        <div style="font-size: 0.8rem; color: var(--gray-600);">Contracts</div>
                   </div>
               </div>
               <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                   <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                       <div style="width: 12px; height: 12px; border-radius: 50%; background: #3498db;"></div>
                       <span>Active ({{ contracts_by_status.active }})</span>
                   </div>
                   <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                       <div style="width: 12px; height: 12px; border-radius: 50%; background: #27ae60;"></div>
                       <span>Completed ({{ contracts_by_status.completed }})</span>
                   </div>
                   <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                       <div style="width: 12px; height: 12px; border-radius: 50%; background: #f39c12;"></div>
                       <span>Pending ({{ contracts_by_status.pending }})</span>
                   </div>
                   <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                       <div style="width: 12px; height: 12px; border-radius: 50%; background: #95a5a6;"></div>
                       <span>Draft ({{ contracts_by_status.draft }})</span>
                   </div>
               </div>
               {% else %}
               <div style="color: var(--gray-500); text-align: center;">
                   <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                   <p>No contracts to display</p>
               </div>
               {% endif %}
               {% endwith %}
           </div>
       </div>
   </div>
   
   <div class="analytics-card">
       <div class="analytics-header">
           <h3 class="analytics-title">Contract Types</h3>
           <span class="analytics-period">All Time</span>
       </div>
       <div class="chart-container">
           <div style="padding: 1rem; height: 100%; overflow-y: auto;">
               {% for type, count in contracts_by_type.items %}
               {% if count > 0 %}
               <div style="margin-bottom: 1rem;">
                   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                       <span style="font-weight: 500; text-transform: capitalize;">{{ type|capfirst }}</span>
                       <span style="font-weight: 600; color: var(--primary-blue);">{{ count }}</span>
                   </div>
                   <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">
                       {% with total_contracts=contracts_by_type.values|join:"|"|split:"|"|length %}
                       <div style="width: {% widthratio count 10 100 %}%; height: 100%; background: linear-gradient(90deg, var(--primary-blue), var(--secondary-teal)); border-radius: 4px;"></div>
                       {% endwith %}
                   </div>
               </div>
               {% endif %}
               {% empty %}
               <div style="color: var(--gray-500); text-align: center; padding: 2rem;">
                   <i class="fas fa-building" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                   <p>No contract types to display</p>
               </div>
               {% endfor %}
           </div>
       </div>
   </div>
   
   <div class="analytics-card" style="grid-column: 1 / -1;">
       <div class="analytics-header">
           <h3 class="analytics-title">Monthly Contract Creation</h3>
           <span class="analytics-period">Last 6 Months</span>
       </div>
       <div class="chart-container">
           {% if monthly_data %}
           <div style="padding: 1rem; height: 100%; display: flex; align-items: end; justify-content: space-around; gap: 1rem;">
               {% for month_data in monthly_data %}
               <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                   <div style="background: linear-gradient(to top, var(--primary-blue), var(--secondary-teal)); width: 100%; max-width: 40px; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem; height: {% if month_data.count > 0 %}{{ month_data.count|mul:20 }}px{% else %}2px{% endif %}; min-height: 2px; transition: height 0.3s ease;"></div>
                   <div style="font-size: 0.8rem; color: var(--gray-600); text-align: center; transform: rotate(-45deg); transform-origin: center;">{{ month_data.month }}</div>
                   <div style="font-size: 0.9rem; font-weight: 600; color: var(--gray-800); margin-top: 0.5rem;">{{ month_data.count }}</div>
               </div>
               {% endfor %}
           </div>
           {% else %}
           <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--gray-500);">
               <div style="text-align: center;">
                   <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                   <p>No monthly data available</p>
               </div>
           </div>
           {% endif %}
       </div>
   </div>
   
   <div class="analytics-card">
       <div class="analytics-header">
           <h3 class="analytics-title">Performance Metrics</h3>
           <span class="analytics-period">This Quarter</span>
       </div>
       <div style="padding: 1rem; display: grid; gap: 1.5rem;">
           <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-lg);">
               <div style="font-size: 1.5rem; font-weight: bold; color: var(--success); margin-bottom: 0.5rem;">
                   {% widthratio contracts_by_status.completed contracts_by_status.active|add:contracts_by_status.completed|add:contracts_by_status.pending|default:1 100 %}%
               </div>
               <div style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 0.5rem;">Success Rate</div>
               <div style="font-size: 0.8rem; color: var(--gray-500);">Contracts completed successfully</div>
           </div>
           
           <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-lg);">
               <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue); margin-bottom: 0.5rem;">
                   {% if contracts_by_status.active > 0 %}7.2{% else %}0{% endif %}
               </div>
               <div style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 0.5rem;">Avg Days Active</div>
               <div style="font-size: 0.8rem; color: var(--gray-500);">Average contract duration</div>
           </div>
           
           <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-lg);">
               <div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary-teal); margin-bottom: 0.5rem;">98.5%</div>
               <div style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 0.5rem;">Client Satisfaction</div>
               <div style="font-size: 0.8rem; color: var(--gray-500);">Based on completed projects</div>
           </div>
       </div>
   </div>
   
   <div class="analytics-card">
       <div class="analytics-header">
           <h3 class="analytics-title">Financial Overview</h3>
           <span class="analytics-period">All Contracts</span>
       </div>
       <div style="padding: 1rem;">
           {% with total_value=contracts_by_status.active|add:contracts_by_status.completed|add:contracts_by_status.pending %}
           {% if total_value > 0 %}
           <div style="display: grid; gap: 1rem;">
               <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: var(--radius-md);">
                   <span style="color: var(--gray-600);">Total Contract Value</span>
                   <span style="font-weight: 600; color: var(--gray-800);">QAR 8.7M</span>
               </div>
               
               <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: var(--radius-md);">
                   <span style="color: var(--gray-600);">Funds in Escrow</span>
                   <span style="font-weight: 600; color: var(--success);">QAR 2.4M</span>
               </div>
               
               <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: var(--radius-md);">
                   <span style="color: var(--gray-600);">Avg Contract Size</span>
                   <span style="font-weight: 600; color: var(--primary-blue);">QAR 850K</span>
               </div>
               
               <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: var(--radius-md);">
                   <span style="color: var(--gray-600);">Monthly Revenue</span>
                   <span style="font-weight: 600; color: var(--secondary-teal);">QAR 1.2M</span>
               </div>
           </div>
           {% else %}
           <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
               <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
               <p>No financial data available</p>
               <small>Create contracts to see financial metrics</small>
           </div>
           {% endif %}
           {% endwith %}
       </div>
   </div>
</div>

{% if contracts_by_status.active|add:contracts_by_status.completed|add:contracts_by_status.pending|add:contracts_by_status.draft == 0 %}
<div class="content-card">
   <div style="text-align: center; padding: 3rem;">
       <div style="width: 80px; height: 80px; background: var(--gray-100); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
           <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--gray-400);"></i>
       </div>
       <h3 style="color: var(--gray-800); margin-bottom: 1rem;">No Analytics Data</h3>
       <p style="color: var(--gray-600); margin-bottom: 2rem;">
           Create contracts to start seeing detailed analytics and performance metrics for your business.
       </p>
       <a href="{% url 'dashboard:contract_create' %}" class="btn btn-primary">
           <i class="fas fa-plus"></i> Create Your First Contract
       </a>
   </div>
</div>
{% endif %}
{% endblock %}